<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Establece una nueva contraseña para tu cuenta en el sistema IDS.">
    <title>Establecer Nueva Contraseña - IDS Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

        :root {
            /* Tema Claro */
            --bg-color: #f4f7f9;
            --container-bg-color: #ffffff;
            --primary-accent-color: #007bff;
            --primary-accent-hover-color: #0056b3;
            --text-color-dark: #212529;
            --text-color-medium: #495057;
            --text-color-light-placeholder: #6c757d;
            --border-color: #dee2e6;
            --input-bg-color: #ffffff;
            --input-focus-border: var(--primary-accent-color);
            --input-focus-shadow: rgba(0, 123, 255, 0.2);
            --success-bg: #d1e7dd; --success-text: #0f5132; --success-border: #badbcc;
            --danger-bg: #f8d7da;  --danger-text: #721c24;  --danger-border: #f5c2c7;
            --info-bg: #cff4fc;    --info-text: #055160;    --info-border: #b6effb;
            --warning-bg: #fff3cd; --warning-text: #664d03; --warning-border: #ffecb5;
            --footer-bg-color: #e9ecef;
            --footer-text-color: var(--text-color-medium);
            --validation-error-color: #dc3545;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color-medium);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            box-sizing: border-box;
            line-height: 1.6;
        }

        .main-content-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            width: 100%;
        }

        .container {
            background-color: var(--container-bg-color);
            padding: 35px 45px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 480px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .container h1 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--text-color-dark);
            font-size: 2em;
            font-weight: 700;
        }

        .container .subtitle {
            margin-bottom: 30px;
            color: var(--text-color-medium);
            font-size: 0.95em;
        }

        .flashes { margin-bottom: 25px; width: 100%; }
        .alert {
            padding: 15px 20px; margin-bottom: 20px; border: 1px solid transparent;
            border-radius: 8px; font-size: 0.95em; text-align: left; display: flex; align-items: center;
        }
        .alert strong { font-weight: 500; margin-right: 8px; }
        .alert-success { background-color: var(--success-bg); color: var(--success-text); border-color: var(--success-border); }
        .alert-danger  { background-color: var(--danger-bg);  color: var(--danger-text);  border-color: var(--danger-border); }
        .alert-info    { background-color: var(--info-bg);    color: var(--info-text);    border-color: var(--info-border); }
        .alert-warning { background-color: var(--warning-bg); color: var(--warning-text); border-color: var(--warning-border); }
        .alert-message { background-color: var(--info-bg);    color: var(--info-text);    border-color: var(--info-border); }

        form { display: flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label {
            display: block; margin-bottom: 8px; color: var(--text-color-dark);
            font-weight: 500; font-size: 0.9em;
        }
        .form-control {
            width: 100%; padding: 13px 16px; border: 1px solid var(--border-color);
            border-radius: 8px; box-sizing: border-box; font-size: 1em;
            color: var(--text-color-dark); background-color: var(--input-bg-color);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-control::placeholder { color: var(--text-color-light-placeholder); font-weight: 300; }
        .form-control:focus {
            outline: none; border-color: var(--input-focus-border);
            box-shadow: 0 0 0 3.5px var(--input-focus-shadow);
        }
        .form-control.is-invalid { /* Estilo para input inválido */
            border-color: var(--danger-border);
        }
        .form-control.is-invalid:focus {
            box-shadow: 0 0 0 3.5px rgba(220, 53, 69, 0.25); /* Sombra roja para inválido en foco */
        }
        .invalid-feedback { /* Estilo para mensajes de error de validación */
            display: none; /* Oculto por defecto */
            width: 100%;
            margin-top: .25rem;
            font-size: .875em;
            color: var(--validation-error-color);
        }
        .form-control.is-invalid ~ .invalid-feedback {
            display: block; /* Mostrar si el input es inválido */
        }


        .btn {
            padding: 14px 20px; border: none; border-radius: 8px; cursor: pointer;
            width: 100%; font-size: 1.05em; font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            letter-spacing: 0.3px; margin-top: 10px; /* Espacio antes del botón */
        }
        .btn-primary {
            background-color: var(--primary-accent-color); color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }
        .btn-primary:hover { background-color: var(--primary-accent-hover-color); box-shadow: 0 6px 16px rgba(0, 123, 255, 0.2); }
        .btn-primary:active { transform: translateY(1px); box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15); }

        .navigation-links { margin-top: 30px; font-size: 0.9em; }
        .navigation-links a { color: var(--primary-accent-color); text-decoration: none; font-weight: 500; }
        .navigation-links a:hover { text-decoration: underline; color: var(--primary-accent-hover-color); }
        
        .site-footer {
            flex-shrink: 0; width: 100%; padding: 20px; text-align: center;
            background-color: var(--footer-bg-color); color: var(--footer-text-color);
            font-size: 0.85em; box-sizing: border-box; border-top: 1px solid var(--border-color);
        }
        .password-strength-meter {
            height: 5px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        .strength-bar {
            height: 100%;
            width: 0%; /* Se actualiza con JS */
            background-color: var(--danger-bg); /* Empieza en rojo */
            transition: width 0.3s ease, background-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="main-content-wrapper">
        <div class="container">
            <h1>Establecer Nueva Contraseña</h1>
            <p class="subtitle">
                Crea una contraseña segura para proteger tu cuenta. Asegúrate de que cumpla con los requisitos.
            </p>

            {# BLOQUE PARA MENSAJES FLASH DE FLASK (Errores del servidor, éxito, etc.) #}
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <div class="flashes">
                  {% for category, message_text in messages %}
                    <div class="alert alert-{{ category if category else 'info' }}">
                      {{ message_text }}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            {# Formulario para restablecer la contraseña. El token se pasa en la URL de acción. #}
            <form method="POST" action="{{ url_for('login.reset_token', token=token) }}" id="resetPasswordForm" novalidate>
                {# CSRF Token - Importante si usas Flask-WTF #}
                {# {% if form and form.csrf_token %} {{ form.csrf_token }} {% endif %} #}

                <div class="form-group">
                    <label for="new_password">Nueva Contraseña:</label>
                    <input type="password" id="new_password" name="new_password" class="form-control" required 
                           placeholder="Mínimo 8 caracteres">
                    <div class="password-strength-meter mt-2">
                        <div class="strength-bar" id="passwordStrengthBar"></div>
                    </div>
                    <div class="invalid-feedback" id="passwordError"></div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirmar Nueva Contraseña:</label>
                    <input type="password" id="confirm_password" name="confirm_password" class="form-control" required 
                           placeholder="Repite la contraseña">
                    <div class="invalid-feedback" id="confirmPasswordError"></div>
                </div>

                <button type="submit" class="btn btn-primary">Restablecer Contraseña</button>
            </form>

            <div class="navigation-links">
                <a href="{{ url_for('login.home') }}">‹ Volver a Inicio de Sesión</a>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        &copy; {% block year %}{{ now().year if now else '2025'}}{% endblock %} IDS Profesional. Comprometidos con tu seguridad.
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('resetPasswordForm');
            const newPasswordInput = document.getElementById('new_password');
            const confirmPasswordInput = document.getElementById('confirm_password');
            const passwordErrorDiv = document.getElementById('passwordError');
            const confirmPasswordErrorDiv = document.getElementById('confirmPasswordError');
            const strengthBar = document.getElementById('passwordStrengthBar');

            // Función para mostrar errores de validación
            function showError(inputElement, errorDiv, message) {
                inputElement.classList.add('is-invalid');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }

            // Función para limpiar errores de validación
            function clearError(inputElement, errorDiv) {
                inputElement.classList.remove('is-invalid');
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }
            
            // Función para actualizar la barra de fortaleza de la contraseña
            function updateStrengthMeter(password) {
                let strength = 0;
                if (password.length >= 8) strength += 1;
                if (password.match(/[A-Z]/)) strength += 1;
                if (password.match(/[a-z]/)) strength +=1; // Un minúscula también suma
                if (password.match(/[0-9]/)) strength += 1; // Un número también suma
                if (password.match(/[^A-Za-z0-9]/)) strength += 1; // Caracter especial

                let barWidth = (strength / 5) * 100; // 5 criterios
                strengthBar.style.width = barWidth + '%';

                if (strength <= 2) {
                    strengthBar.style.backgroundColor = 'var(--danger-bg)';
                } else if (strength <= 4) {
                    strengthBar.style.backgroundColor = 'var(--warning-bg)';
                } else {
                    strengthBar.style.backgroundColor = 'var(--success-bg)';
                }
            }

            if(newPasswordInput) {
                newPasswordInput.addEventListener('input', function() {
                    updateStrengthMeter(this.value);
                    // Limpiar error de este campo al escribir, la validación se hará al enviar
                    clearError(newPasswordInput, passwordErrorDiv); 
                });
            }


            if (form) {
                form.addEventListener('submit', function(event) {
                    let isValid = true;
                    // Limpiar errores previos
                    clearError(newPasswordInput, passwordErrorDiv);
                    clearError(confirmPasswordInput, confirmPasswordErrorDiv);

                    const newPassword = newPasswordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    // 1. Validar longitud (mínimo 8 caracteres)
                    if (newPassword.length < 8) {
                        showError(newPasswordInput, passwordErrorDiv, 'La contraseña debe tener al menos 8 caracteres.');
                        isValid = false;
                    }

                    // 2. Validar mayúscula
                    if (!/[A-Z]/.test(newPassword)) {
                        // Concatenar error si ya hay uno, o establecerlo si es el primero
                        const currentError = passwordErrorDiv.textContent;
                        const newErrorMessage = 'Debe contener al menos una letra mayúscula.';
                        showError(newPasswordInput, passwordErrorDiv, currentError ? currentError + " " + newErrorMessage : newErrorMessage);
                        isValid = false;
                    }

                    // 3. Validar carácter especial
                    if (!/[!@#$%^&*(),.?":{}|<>]/.test(newPassword)) {
                        const currentError = passwordErrorDiv.textContent;
                        const newErrorMessage = 'Debe contener al menos un carácter especial (ej. !@#$%).';
                        showError(newPasswordInput, passwordErrorDiv, currentError ? currentError + " " + newErrorMessage : newErrorMessage);
                        isValid = false;
                    }
                    
                    // 4. Validar que las contraseñas coincidan
                    if (newPassword !== confirmPassword) {
                        showError(confirmPasswordInput, confirmPasswordErrorDiv, 'Las contraseñas no coinciden.');
                        isValid = false;
                    } else if (confirmPasswordInput.value && isValid) { 
                        // Si la contraseña de confirmación tiene valor y no hay otros errores de contraseña nueva, limpiar su error
                        clearError(confirmPasswordInput, confirmPasswordErrorDiv);
                    }


                    if (!isValid) {
                        event.preventDefault(); // Detener el envío del formulario si hay errores
                    }
                    // Si isValid es true, el formulario se enviará normalmente.
                });
            }
            
            // Redirección por mensaje de éxito (si vienes de un restablecimiento exitoso)
            const successAlert = document.querySelector('.alert-success'); // Para mensajes flash del servidor
            const loginUrl = "{{ url_for('login.home', _external=True) }}"; 

            if (successAlert && successAlert.offsetParent !== null && successAlert.textContent.includes('Tu contraseña ha sido restablecida exitosamente')) { 
                setTimeout(function() {
                    window.location.href = loginUrl;
                }, 4000); // Redirige después de 4 segundos
            }
        });
    </script>
    {# Para que now().year funcione, necesitas un procesador de contexto en Flask:
       from datetime import datetime
       @app.context_processor
       def utility_processor():
           return dict(now=datetime.utcnow)
       O simplemente reemplaza con el año actual directamente.
    #}
</body>
</html>